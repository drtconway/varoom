#include "varoom/vcf/vcf_parser.hpp"

#include <fstream>

#define BOOST_TEST_DYN_LINK
#define BOOST_TEST_MODULE vcf_parser tests
#include <boost/test/unit_test.hpp>

namespace // anonymous
{
    class vcf_tester : public varoom::vcf::vcf_handler
    {
    public:
        std::vector<int64_t> positions;
        int64_t ind;
        vcf_tester()
            : positions({
                891407, 897788, 1289599, 1361641, 1430870, 1569967, 1720700, 3732103,
                6314644, 9816594, 13695769, 15844676, 16064514, 17083823, 17322657,
                21563382, 22446492, 22927148, 24669465, 24671398, 27238426, 27709077,
                28862730, 34164594, 35734684, 36558704, 43166675, 44071037, 53072327,
                53746345, 54694082, 67437317, 77763291, 84644927, 85397087, 93724464,
                103491491, 108298171, 113456680, 116573971, 117527468, 117552779,
                118482202, 120277941, 150529741, 151774497, 152944568, 153317717,
                153967598, 154560980, 155186438, 156106999, 156236157, 156930294,
                157069160, 159858209, 160143937, 160319492, 161518408, 163131737,
                176826763, 179816006, 182551384, 183204671, 186055334, 186121898,
                192153383, 198713178, 200080458, 201458013, 202403816, 202828000,
                206649552, 206822344, 211751745, 211924424, 212179931, 214820682,
                215342626, 227300496, 236154399, 236723142, 248262983, 249144707, 9572823,
                10263003, 18758156, 21361978, 26683035, 27325509, 27600277, 27800002,
                31604462, 32412204, 32449553, 32620693, 37353434, 42887036, 44021669,
                44049900, 44531251, 70164337, 72371460, 86333467, 86343734, 86408491,
                86968109, 97363349, 100015874, 107040378, 108998330, 109432599, 113742626,
                122135212, 122285346, 122288449, 128408244, 130900796, 131897750,
                136073025, 142238113, 143746486, 160692081, 162273191, 162273587,
                166805888, 166872217, 169712005, 175450269, 179418145, 179495020,
                179556803, 179701998, 182340620, 183600969, 183616338, 183847983,
                191399337, 191788759, 196642687, 197595697, 197634602, 198367753,
                202521071, 216289984, 219128042, 219267176, 219529975, 219536606,
                219875685, 219941946, 220078233, 220329249, 220349505, 220370684,
                233759528, 234545357, 234628002, 234905053, 239990562, 241459811,
                241816847, 241973136, 242275319, 4490964, 4725465, 8675636, 9475615,
                9975193, 9979300, 10084885, 13545973, 15477983, 15621358, 16535406,
                16638953, 33623407, 38347840, 38648258, 38913023, 39227602, 39230586,
                42167121, 48621247, 49153379, 49738034, 49967292, 51864852, 52156457,
                52312185, 52542438, 52853975, 53845342, 58519870, 63601106, 69153715,
                96533492, 111394233, 112548142, 113377447, 114018492, 119900216,
                121251833, 121411050, 126153119, 129020895, 129034675, 129214457,
                130346170, 130368059, 132389901, 145924515, 148919995, 150263804,
                151129293, 155551319, 156763094, 167320099, 169802721, 172351677,
                180377271, 195513468, 674318, 676543, 844756, 844890, 1739417, 1961151,
                3009606, 3319770, 6878339, 9370172, 10573406, 25750053, 47973114,
                56448359, 69978267, 75959129, 77036591, 82073228, 111463965, 114279660,
                123108572, 152640707, 155249337, 187088121, 188924685, 1219081, 7816967,
                7866004, 7869363, 14364857, 31323208, 31983610, 32071567, 35954582,
                52285311, 52285381, 54931338, 56177657, 56777800, 58286746, 63510093,
                68411784, 75948680, 76330307, 82969241, 113698695, 118824992, 118968408,
                131296175, 136957749, 140039443, 140604484, 140698817, 140735534,
                140795318, 141018604, 145439538, 149907595, 150029539, 150138378,
                150646436, 153433049, 153795465, 156770012, 158526465, 159849614,
                172386838, 176759117, 4077586, 4892495, 8097697, 11044454, 14131804,
                15496724, 16327823, 17779270, 28321681, 28971694, 29910493, 30615023,
                31138050, 31805174, 32713159, 33381488, 36104211, 42018287, 42227267,
                43484452, 43970484, 49700987, 52550758, 52957672, 53374062, 54254685,
                56047422, 56469926, 56997852, 63921507, 65707507, 71276724, 75855145,
                79577503, 83843868, 83867020, 87968757, 90090021, 99955427, 110636519,
                111368434, 116574396, 116784794, 119515066, 125292741, 125575040,
                131211473, 135358132, 138833470, 139565772, 143092757, 144744791,
                152694182, 168348522, 170168190, 1478440, 2317882, 3990657, 5256776,
                6084330, 7529030, 20197930, 20683255, 20824956, 21598402, 26225008,
                30700162, 30868343, 33192463, 36478810, 47857615, 47874612, 48887701,
                53103382, 57187801, 66703342, 73245957, 73604571, 75070420, 75221691,
                84628811, 84636307, 92734357, 99719886, 99818254, 99956435, 100402988,
                100685151, 102108569, 103048421, 111512663, 126249524, 130021058,
                134133728, 142008541, 142028399, 149521514, 150748070, 151329182,
                424655, 2820141, 3046493, 3205655, 6914076, 7807682, 11995229, 16961884,
                17812966, 22414221, 24333957, 26149285, 27401754, 28309995, 37630318,
                38122487, 48771424, 70512876, 94800050, 97307490, 99101440, 99170454,
                101157215, 103297304, 104384855, 110418682, 110448685, 110499007,
                119945263, 124993032, 130867806, 135533170, 142204197, 142221564,
                144946980, 145608426, 145622040, 145754166, 712149, 5906948, 6330219,
                19336415, 33270583, 35842535, 37512704, 85615211, 90535488, 90538372,
                92220818, 93983055, 94172876, 94486097, 99404175, 101801053, 107624126,
                110249741, 112145765, 114356501, 115038103, 117228556, 127639206,
                128434668, 130127549, 130213641, 130929194, 131355249, 131456245,
                131890327, 132591468, 134501655, 138150531, 139369743, 139758285,
                139837062, 140006281, 12160799, 15880213, 22605305, 23297336, 26518679,
                26562554, 27459074, 27504597, 35317819, 43292826, 58117937, 63810734,
                68139039, 70406518, 70508910, 70721954, 70916844, 88730214, 93719953,
                96447935, 96701580, 99120302, 102057141, 103899405, 104592872, 105201695,
                106976831, 116931115, 118351878, 127409905, 127540968, 128785757,
                134261225, 134503877, 406336, 800635, 1272138, 1311615, 1782656, 2170356,
                3111157, 3794855, 5067836, 5462732, 5905859, 6912767, 11971462, 12902508,
                12951705, 17548724, 44092841, 44289156, 44956582, 45938974, 46665829,
                46812086, 48157703, 51411589, 56756844, 57563165, 58207070, 58980116,
                59282845, 61608026, 61658814, 62744657, 63276127, 64435157, 64519368,
                64602328, 64677520, 65360600, 65648866, 65744554, 66323638, 66618667,
                67166649, 67235569, 67352165, 68478307, 70336495, 71238445, 71727087,
                73785278, 74556210, 76823604, 77383097, 89896227, 92534263, 103178476,
                105009787, 113854031, 115085486, 117050028, 117332187, 119056917,
                124793322, 126124289, 134131683, 2908330, 4634498, 4708256, 7060811,
                7276715, 7636144, 8687284, 15102790, 16425664, 21918715, 30877337,
                31944767, 32135498, 32908678, 46328232, 47178351, 48380593, 49062871,
                49500576, 50642566, 52408468, 52709135, 52884631, 52964444, 53045438,
                53201413, 53291424, 53292527, 54069975, 56436238, 56680411, 79679727,
                80760321, 101436251, 108082517, 110318141, 112919887, 114380261,
                117977498, 120260828, 120990388, 121878582, 123097729, 132497768,
                133198318, 21237552, 23939368, 28136502, 33253030, 42875939, 46924257,
                50465211, 60545064, 60590220, 76416136, 78173843, 80911354, 98664617,
                103459881, 106124871, 108518419, 113140311, 21269769, 21486418, 23312654,
                23451318, 23859585, 38679662, 39639313, 45603637, 51716120, 52794082,
                58896176, 58932664, 61747562, 64152907, 66028307, 72190468, 88967581,
                91770032, 91773374, 92040687, 93154428, 94756847, 95566250, 104174888,
                105414150, 22414341, 24922048, 34530637, 40062793, 41362640, 42565480,
                42678130, 42742065, 43028596, 43484909, 43814581, 45391576, 48483907,
                49170450, 50751343, 51039740, 51669640, 63569934, 63632589, 63634159,
                65115955, 65956631, 74483632, 75660365, 75980354, 82517648, 89402296,
                89807175, 89870080, 91290720, 91512260, 100516214, 101598285, 722240,
                1268266, 1544420, 1604941, 1652614, 2235082, 3576515, 3646328, 4382351,
                5009390, 14976405, 15834097, 19580714, 20482830, 20970504, 21038304,
                21133425, 22153968, 23080182, 23119392, 23646974, 24942549, 26147171,
                28354115, 28917425, 29888707, 30008102, 30199867, 31045824, 31419746,
                32265100, 56670449, 58076105, 66801356, 67265594, 70506508, 71683445,
                81129884, 81303904, 84070309, 85688434, 87735973, 89350768, 89777706,
                90028142, 90103788, 2298170, 3470238, 4445181, 4637997, 4904718, 6350750,
                7216127, 7476056, 7573059, 7750839, 7802720, 8006674, 17075220, 18707422,
                27047897, 27075265, 27417146, 27419897, 28890194, 29645703, 35931919,
                36482758, 38450259, 38551771, 38643725, 39186225, 39197307, 39623442,
                39888399, 40049474, 40725490, 41108373, 42992752, 45915187, 46622045,
                47486475, 48605550, 48917337, 56274530, 57955635, 61833595, 62850787,
                62856683, 65900976, 66872663, 67252413, 71165600, 71394509, 72365589,
                72469925, 72846742, 72848183, 79174227, 80231185, 8610044, 21422705,
                33877778, 43483918, 44408086, 51809321, 55983244, 56008396, 56998732,
                74696694, 76755197, 76757285, 877146, 1085848, 1818622, 7547056, 7831167,
                8670148, 9050078, 9939395, 11238761, 11541986, 11917496, 12358272,
                13002103, 13039339, 15791250, 16902438, 17122343, 18555544, 19313651,
                19625870, 20044900, 21116955, 21720894, 22363605, 22498619, 33370251,
                36940943, 37642863, 37726855, 38126259, 39908158, 40330933, 40520485,
                40537922, 41533092, 41597805, 41709329, 41828524, 41945779, 42384950,
                44677001, 45867736, 46387524, 49362710, 49368779, 49459411, 49965791,
                50310377, 51957556, 51981917, 52693482, 53085924, 54172501, 54655915,
                55590469, 55739462, 58965558, 3218604, 3759128, 13071905, 25304077,
                31024505, 31631108, 31670716, 31825604, 32345018, 34775548, 42242560,
                44581241, 44682179, 45014752, 56090714, 57768848, 60883828, 60891899,
                61542464, 62172270, 62324508, 19704486, 27102026, 32624430, 34956937,
                37518341, 37605079, 38610834, 38884399, 43166336, 45535681, 47686993,
                20128845, 23029727, 23135093, 23135289, 23165682, 23223605, 26173613,
                29915079, 30189309, 31328977, 32587140, 35811852, 37485769, 38026026,
                38565467, 39709250, 39917434, 41174963, 43272982, 44681502, 46773012,
                50903628, 50964360, 1471273, 1506358, 2876490, 23019462, 30737540,
                39933215, 46949441, 54276592, 69497527, 73965368, 117528020, 118514115,
                119513331, 153037633, 153051584, 153141256, 153633198, 154013323
            }), ind(0)
        {
        }

        virtual void operator()(const std::string& p_chr,
                                const std::int64_t& p_pos,
                                const std::string& p_id,
                                const std::string& p_ref,
                                const std::string& p_alt,
                                const std::int64_t& p_qual,
                                const std::string& p_filter,
                                const varoom::vcf::lazy_vcf_info& p_info,
                                const varoom::lazy<std::vector<varoom::vcf::vcf_info>>& p_genotypes)
        {
            BOOST_CHECK_EQUAL(p_pos, positions[ind++]);
            switch (ind)
            {
                case 52:
                case 127:
                case 591:
                case 680:
                case 692:
                case 912:
                case 920:
                {
                    BOOST_CHECK_EQUAL(p_info.get().size(), 79);
                    break;
                }
                case 311:
                case 783:
                {
                    BOOST_CHECK_EQUAL(p_info.get().size(), 71);
                    break;
                }
                case 908:
                case 909:
                case 910:
                case 911:
                case 913:
                case 914:
                case 915:
                case 916:
                case 917:
                case 918:
                case 919:
                case 921:
                case 922:
                case 924:
                case 925:
                {
                    BOOST_CHECK_EQUAL(p_info.get().size(), 83);
                    break;
                }
                {
                    BOOST_CHECK_EQUAL(p_info.get().size(), 83);
                    break;
                }
                {
                    BOOST_CHECK_EQUAL(p_info.get().size(), 83);
                    break;
                }
                case 923:
                {
                    BOOST_CHECK_EQUAL(p_info.get().size(), 87);
                    break;
                }
                default:
                {
                    BOOST_CHECK_EQUAL(p_info.get().size(), 75);
                    break;
                }
            }
        }

        virtual void error(const size_t& p_line_no, const std::string& p_line, const std::string& p_message)
        {
        }
    };
}
// namespace anonymous

BOOST_AUTO_TEST_CASE( test1 )
{
    using namespace std;
    using namespace varoom::vcf;

    ifstream in("tests/data/exac-few.vcf");

    vcf_tester T;
    vcf_parser P(T);
    P.parse(in);
}
